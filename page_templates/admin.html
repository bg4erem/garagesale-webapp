<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">    </head>

</head>
<body>
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="/">Гаражная распродажа</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                    <li class="nav-item"><a class="nav-link" href="/">Главная</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin_page">Admin</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Login Container -->
    <div class="container" id="login-form" style="text-align: center;">
        <h4>Admin Login</h4>
        <div class="row justify-content-center">
            <div class="col-sm-4"><input class="form-control col-sm-8" type="number" id="pin" placeholder="Enter PIN"></div>
            <button class="btn btn-outline-primary col-sm-4" onclick="authenticate()">Login</button>
        </div>
    </div>

    <!-- Admin Container -->
    <div class="container mt-3" id="admin-content" style="display:none;">
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalCreateObject">
            Create Item
        </button>
    </div>

    <div class="modal fade" id="modalCreateObject" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalCreateObjectLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title fs-5" id="modalCreateObjectLabel">Create Item</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="item-form" enctype="multipart/form-data">
                        <input class="form-control" placeholder="Title" type="text" id="title" name="title" required><br>
                        <textarea class="form-control" placeholder="Description" id="description" name="description" required></textarea><br>
                        <input class="form-control" placeholder="Price" type="number" step="0.01" min="0" id="price" name="price" required><br>
                        <input class="form-control" placeholder="Full Price (not required)" type="number" step="0.01" min="0" id="full_price" name="full_price"><br>
                        <label for="photos">Photos/Videos:</label><br>
                        <input class="form-control" type="file" id="photos" name="photos" accept="image/*, video/*" multiple><br>
                        
                        <h5>Properties:</h5>
                        <div id="properties-container">
                            <!-- Property fields will be added dynamically here -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addProperty()">Add Property</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnItemFormSubmit" class="btn btn-primary" onclick="createItem()">Create Item</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        function authenticate() {
            var pin = document.getElementById("pin").value;
            
            // Make API call to authenticate PIN
            fetch(`/api/v1/verify_pin?pin=${pin}`, {method: 'POST'})
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Authentication failed');
                }
            })
            .then(data => {
                // Show admin content
                document.getElementById("login-form").style.display = "none";
                document.getElementById("admin-content").style.display = "block";
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Authentication failed. Please try again.');
            });
        }

        // Check if admin PIN is already stored in cookies
        window.onload = function() {
            var pin = getCookie("adminPin");
            if (pin) {
                // If PIN is found, auto-login
                document.getElementById("pin").value = pin;
                authenticate();
            }
        }

        function getCookie(name) {
            var cookieArr = document.cookie.split("; ");
            for (var i = 0; i < cookieArr.length; i++) {
                var cookiePair = cookieArr[i].split("=");
                if (name == cookiePair[0]) {
                    return cookiePair[1];
                }
            }
            return null;
        }
        
        function addProperty() {
            var propertiesContainer = document.getElementById("properties-container");
            
            var propertyDiv = document.createElement("div");
            propertyDiv.classList.add("property");
            propertyDiv.classList.add("input-group");
            
            var nameInput = document.createElement("input");
            nameInput.className = "form-control";
            nameInput.placeholder = "Name";
            nameInput.type = "text";
            nameInput.name = "properties.name";
            
            var valueInput = document.createElement("input");
            valueInput.className = "form-control";
            valueInput.placeholder = "Value";
            valueInput.type = "text";
            valueInput.name = "properties.value";
            
            var displayCheckDiv = document.createElement("div");
            displayCheckDiv.className = "form-check";
            var displayLabel = document.createElement("label");
            displayLabel.className = "form-check-label";
            displayLabel.textContent = "Display:";
            var displayInput = document.createElement("input");
            displayInput.className = "form-check-input";
            displayInput.type = "checkbox";
            displayInput.checked = true;
            displayInput.name = "properties.display";
            displayCheckDiv.appendChild(displayLabel);
            displayCheckDiv.appendChild(displayInput);

            var deleteIcon = document.createElement("i");
            deleteIcon.className = "bi bi-trash"
            deleteIcon.addEventListener("click", function() {
                propertiesContainer.removeChild(propertyDiv);
            });

            propertyDiv.appendChild(nameInput);
            propertyDiv.appendChild(valueInput);
            propertyDiv.appendChild(displayCheckDiv);
            propertyDiv.appendChild(deleteIcon);

            propertiesContainer.appendChild(propertyDiv);
        }
        
        async function createItem() {
            const formItem = document.getElementById("item-form");
            if (formItem.checkValidity()) {
                document.getElementById("btnItemFormSubmit").disabled = true;

                let itemObject = {}
                itemObject["title"] = formItem.elements.title.value.trim();
                itemObject["description"] = formItem.elements.description.value.trim();
                if (formItem.elements.full_price.value) { itemObject["full_price"] = formItem.elements.full_price.value }
                itemObject["price"] = formItem.elements.price.value
                itemObject["photos"] = []
                itemObject["properties"] = []
                
                if (formItem.elements.namedItem("properties.name")) {
                    const propertyNameInputs = formItem.elements.namedItem("properties.name")
                    const propertyValueInputs = formItem.elements.namedItem("properties.value")
                    const propertyDisplayInputs = formItem.elements.namedItem("properties.display")

                    for (let i = 0; i < propertyNameInputs.length; i++ ) {
                        let property = {}
                        property["name"] = propertyNameInputs[i].value.trim();
                        property["value"] = propertyValueInputs[i].value.trim();
                        property["display"] = propertyDisplayInputs[i].checked
                        itemObject["properties"].push(property)
                    }
                }

                if (formItem.elements.photos.files.length > 0 ) {
                    let formPhotosData = new FormData();
                    for (let i=0; i < formItem.elements.photos.files.length; i++) {
                        formPhotosData.append("files", formItem.elements.photos.files[i])
                    }

                    itemObject["photos"] = await fetch(
                        "/api/v1/upload_files",
                        {"method":"post", "body": formPhotosData}
                    ).then(response => {
                        if (response.ok) {
                            return response.json()
                        } else {
                            throw new Error("Error uploading file")
                        }
                    })
                }
                
                await fetch (
                    "/api/v1/items", 
                    {"method":"post", "headers":{"Content-Type":"application/json"}, "body":JSON.stringify(itemObject)}
                ).then( response => {
                    if (response.ok) {
                        formItem.reset();
                        document.getElementById("btnItemFormSubmit").disabled = false;
                        var propertiesContainer = document.getElementById("properties-container");
                        propertiesContainer.innerHTML = "";
                        alert(`Created: ${itemObject["title"]}`);
                    }
                })
            } else {
                formItem.reportValidity();
            }
        }
    </script>
</body>
</html>
